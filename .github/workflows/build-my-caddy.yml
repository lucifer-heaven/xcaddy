name: Build and Release Latest Caddy

# 【重要】必须添加 permissions 块，赋予 Actions 写入 Release 的权限
permissions:
  contents: write

on:
  workflow_dispatch: # 手动触发

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install xcaddy
        run: go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest

      - name: Build Caddy with Cloudflare
        run: |
          ~/go/bin/xcaddy build \
            --with github.com/caddy-dns/cloudflare \
            --output caddy_linux_amd64

      - name: Update Release with Latest Binary
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest          # 强制使用固定的 "latest" 标签
          name: Latest Build        # Release 的标题
          body: "Auto-built Caddy with Cloudflare DNS plugin."
          files: caddy_linux_amd64  # 要上传的文件
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
